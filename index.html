<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Openen in desktop-app</title>
  <style>
    body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
    .box{max-width:720px;padding:16px;border:1px solid #cfe3ff;border-radius:8px;background:#f5faff;color:#123}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:4px;text-decoration:none;border:1px solid #c8c8c8;background:#fff;color:#333;display:inline-block}
    .btn-primary{background:#0078d4;color:#fff;border-color:#0078d4}
    small{display:block;margin-top:8px;color:#555}
  </style>
</head>
<body>
  <div class="box">
    <div id="msg"><strong>Openen in desktop-app…</strong></div>
    <div class="actions">
      <a id="openDesktop" class="btn btn-primary" href="#">Open in desktop-app</a>
      <a id="openWeb" class="btn" href="#" target="_self">Open in web</a>
      <a id="directLink" class="btn" href="#" target="_blank">Directe link</a>
    </div>
    <small id="details"></small>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const uRaw = qs.get('u');                // verwacht: DocIdRedir of echte file-URL
      const app = (qs.get('app') || '').toLowerCase(); // optioneel hint: word|excel|powerpoint
      const auto = qs.get('auto') === '1';     // optioneel: auto-launch
      if (!uRaw) {
        document.getElementById('msg').innerHTML = "Geen bestands-URL gevonden (<code>?u=...</code>).";
        return;
      }

      // 1) Altijd encoden t.b.v. protocol handler
      //    (we accepteren zowel al-geencodeerde als platte input)
      let u;
      try {
        // als al ge-encodeerd is: decode -> re-encode (uniform)
        u = encodeURIComponent(decodeURIComponent(uRaw));
      } catch {
        u = encodeURIComponent(uRaw);
      }

      // 2) Kies scheme; met generieke ms-office fallback als app onbekend
      const scheme =
        app === 'word' ? 'ms-word:ofe|u|' :
        app === 'excel' ? 'ms-excel:ofe|u|' :
        app === 'powerpoint' ? 'ms-powerpoint:ofe|u|' :
        'ms-office:ofe|u|';

      const desktopHref = scheme + u;

      // 3) Web fallback: zonder extra kennis gebruiken we de aangeleverde URL zelf
      //    (DocIdRedir werkt prima in web)
      const webFallback = uRaw;
      const openDesktop = document.getElementById('openDesktop');
      const openWeb = document.getElementById('openWeb');
      const directLink = document.getElementById('directLink');
      const details = document.getElementById('details');

      openDesktop.href = desktopHref;      // user gesture → hoogste kans van slagen
      openWeb.href = webFallback;
      directLink.href = webFallback;

      details.textContent = `Desktop: ${desktopHref}  •  Web fallback: ${webFallback}`;

      // 4) Optioneel auto-launch (kan door browser worden geblokkeerd)
      if (auto) {
        // Probeer via tijdelijke <a> klik (soms minder geblokkeerd dan location=)
        const a = document.createElement('a');
        a.href = desktopHref;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        setTimeout(() => { location.href = webFallback; }, 1200);
      }
    })();
  </script>
</body>
</html>
