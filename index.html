<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <title>Openen in desktop-app</title>
  <style>
    body{font-family:sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0}
    .box{max-width:720px;padding:16px;border:1px solid #cfe3ff;border-radius:8px;background:#f5faff;color:#123}
    .actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{padding:8px 12px;border-radius:4px;text-decoration:none;border:1px solid #c8c8c8;background:#fff;color:#333;display:inline-block}
    .btn-primary{background:#0078d4;color:#fff;border-color:#0078d4}
    small{display:block;margin-top:8px;color:#555}
  </style>
</head>
<body>
  <div class="box">
    <div id="msg"><strong>Openen in desktop-app…</strong></div>
    <div class="actions">
      <a id="openDesktop" class="btn btn-primary" href="#">Open in desktop-app</a>
      <a id="openWeb" class="btn" href="#" target="_self">Open in web</a>
      <a id="directLink" class="btn" href="#" target="_blank">Directe link</a>
    </div>
    <small id="details"></small>
  </div>

<script>
  (function () {
    const qs = new URLSearchParams(location.search);
    const uRaw = qs.get('u');
    let app = (qs.get('app') || '').toLowerCase();
    const auto = qs.get('auto') === '1';

    const msgEl = document.getElementById('msg');
    const details = document.getElementById('details');
    const openDesktop = document.getElementById('openDesktop');
    const openWeb = document.getElementById('openWeb');
    const directLink = document.getElementById('directLink');

    if (!uRaw) {
      msgEl.innerHTML = "Geen bestands-URL gevonden (<code>?u=...</code>).";
      return;
    }

    // Probeer app te raden uit extensie; met DocIdRedir lukt dat vaak niet, maar kan geen kwaad.
    if (!app) {
      try {
        const p = new URL(uRaw).pathname.toLowerCase();
        if (/\.(docx?|rtf)$/.test(p)) app = 'word';
        else if (/\.(xlsx?|csv)$/.test(p)) app = 'excel';
        else if (/\.(pptx?)$/.test(p)) app = 'powerpoint';
      } catch {}
    }

    // Encode 'u' voor de protocol handler
    let uEnc;
    try { uEnc = encodeURIComponent(decodeURIComponent(uRaw)); } catch { uEnc = encodeURIComponent(uRaw); }

    // Gebruik app-specifiek indien gegeven; anders generieke fallback
    const scheme =
      app === 'word' ? 'ms-word:ofe|u|' :
      app === 'excel' ? 'ms-excel:ofe|u|' :
      app === 'powerpoint' ? 'ms-powerpoint:ofe|u|' :
      'ms-office:ofe|u|';

    const desktopHref = scheme + uEnc;
    const webFallback = uRaw; // DocIdRedir werkt prima in web

    // Knoppen vullen
    openDesktop.href = desktopHref;
    openWeb.href = webFallback;
    directLink.href = webFallback;
    details.textContent = `App: ${app || '(onbekend)'} • Desktop: ${desktopHref} • Web fallback: ${webFallback}`;

    // --- Belangrijk: fallback annuleren zodra we focus/visibility verliezen ---
    let fellBack = false;
    let timer = null;

    function cancelFallback(reason) {
      if (timer) {
        clearTimeout(timer);
        timer = null;
        // optioneel voor debug:
        // details.textContent += ` • fallback geannuleerd (${reason})`;
      }
    }

    function scheduleFallback() {
      cancelFallback();
      timer = setTimeout(function () {
        if (!fellBack) {
          fellBack = true;
          location.href = webFallback;
        }
      }, 2500); // iets ruimer dan 1200ms
    }

    // Als de Office-app opent, verliest de pagina meestal focus of wordt verborgen
    window.addEventListener('blur', () => cancelFallback('blur'));
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) cancelFallback('hidden');
    });
    window.addEventListener('pagehide', () => cancelFallback('pagehide'));

    // Klik handler: start desktop en zet fallback-timer
    openDesktop.addEventListener('click', function (e) {
      // expliciet: laat de browser de protocol-URL volgen
      // (geen preventDefault)
      scheduleFallback();
    });

    // Auto-launch (optioneel, via &auto=1). Kan door browser geblokkeerd worden.
    if (auto) {
      // Truc: klik het <a> element programmatically (user-gesture achtiger dan location=)
      scheduleFallback();
      openDesktop.click();
    }
  })();
</script>

</body>
</html>
